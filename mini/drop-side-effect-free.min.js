import{AST_Accessor,AST_Array,AST_Arrow,AST_Assign,AST_Binary,AST_Call,AST_Chain,AST_Class,AST_ClassStaticBlock,AST_ClassProperty,AST_ConciseMethod,AST_Conditional,AST_Constant,AST_DefClass,AST_Dot,AST_Expansion,AST_Function,AST_Node,AST_Number,AST_Object,AST_ObjectGetter,AST_ObjectKeyVal,AST_ObjectProperty,AST_ObjectSetter,AST_PropAccess,AST_Scope,AST_Sequence,AST_SimpleStatement,AST_Sub,AST_SymbolRef,AST_TemplateSegment,AST_TemplateString,AST_This,AST_Unary}from"../ast.js";import{make_node,return_null,return_this}from"../utils/index.js";import{first_in_statement}from"../utils/first_in_statement.js";import{pure_prop_access_globals}from"./native-objects.js";import{lazy_op,unary_side_effects,is_nullish_shortcircuited}from"./inference.js";import{WRITE_ONLY,set_flag,clear_flag}from"./compressor-flags.js";import{make_sequence,is_func_expr,is_iife_call}from"./common.js";function def_drop_side_effect_free(e,t){e.DEFMETHOD("drop_side_effect_free",t)}function trim(e,t,s){var r=e.length;if(!r)return null;for(var i=[],_=!1,f=0;f<r;f++){var n=e[f].drop_side_effect_free(t,s);_|=n!==e[f],n&&(i.push(n),s=!1)}return _?i.length?i:null:e}def_drop_side_effect_free(AST_Node,return_this),def_drop_side_effect_free(AST_Constant,return_null),def_drop_side_effect_free(AST_This,return_null),def_drop_side_effect_free(AST_Call,(function(e,t){if(is_nullish_shortcircuited(this,e))return this.expression.drop_side_effect_free(e,t);if(!this.is_callee_pure(e)){if(this.expression.is_call_pure(e)){var s=this.args.slice();return s.unshift(this.expression.expression),(s=trim(s,e,t))&&make_sequence(this,s)}if(is_func_expr(this.expression)&&(!this.expression.name||!this.expression.name.definition().references.length)){var r=this.clone();return r.expression.process_expression(!1,e),r}return this}var i=trim(this.args,e,t);return i&&make_sequence(this,i)})),def_drop_side_effect_free(AST_Accessor,return_null),def_drop_side_effect_free(AST_Function,return_null),def_drop_side_effect_free(AST_Arrow,return_null),def_drop_side_effect_free(AST_Class,(function(e){const t=[],s=this.extends&&this.extends.drop_side_effect_free(e);s&&t.push(s);for(const s of this.properties)if(s instanceof AST_ClassStaticBlock){if(s.has_side_effects(e))return this}else{const r=s.drop_side_effect_free(e);if(r){if(r.contains_this())return this;t.push(r)}}if(!t.length)return null;const r=make_sequence(this,t);return this instanceof AST_DefClass?make_node(AST_SimpleStatement,this,{body:r}):r})),def_drop_side_effect_free(AST_ClassProperty,(function(e){const t=this.computed_key()&&this.key.drop_side_effect_free(e),s=this.static&&this.value&&this.value.drop_side_effect_free(e);return t&&s?make_sequence(this,[t,s]):t||s||null})),def_drop_side_effect_free(AST_Binary,(function(e,t){var s=this.right.drop_side_effect_free(e);if(!s)return this.left.drop_side_effect_free(e,t);if(lazy_op.has(this.operator)){if(s===this.right)return this;var r=this.clone();return r.right=s,r}var i=this.left.drop_side_effect_free(e,t);return i?make_sequence(this,[i,s]):this.right.drop_side_effect_free(e,t)})),def_drop_side_effect_free(AST_Assign,(function(e){if(this.logical)return this;var t=this.left;if(t.has_side_effects(e)||e.has_directive("use strict")&&t instanceof AST_PropAccess&&t.expression.is_constant())return this;for(set_flag(this,WRITE_ONLY);t instanceof AST_PropAccess;)t=t.expression;return t.is_constant_expression(e.find_parent(AST_Scope))?this.right.drop_side_effect_free(e):this})),def_drop_side_effect_free(AST_Conditional,(function(e){var t=this.consequent.drop_side_effect_free(e),s=this.alternative.drop_side_effect_free(e);if(t===this.consequent&&s===this.alternative)return this;if(!t)return s?make_node(AST_Binary,this,{operator:"||",left:this.condition,right:s}):this.condition.drop_side_effect_free(e);if(!s)return make_node(AST_Binary,this,{operator:"&&",left:this.condition,right:t});var r=this.clone();return r.consequent=t,r.alternative=s,r})),def_drop_side_effect_free(AST_Unary,(function(e,t){if(unary_side_effects.has(this.operator))return this.expression.has_side_effects(e)?clear_flag(this,WRITE_ONLY):set_flag(this,WRITE_ONLY),this;if("typeof"==this.operator&&this.expression instanceof AST_SymbolRef)return null;var s=this.expression.drop_side_effect_free(e,t);return t&&s&&is_iife_call(s)?s===this.expression&&"!"==this.operator?this:s.negate(e,t):s})),def_drop_side_effect_free(AST_SymbolRef,(function(e){return this.is_declared(e)||pure_prop_access_globals.has(this.name)?null:this})),def_drop_side_effect_free(AST_Object,(function(e,t){var s=trim(this.properties,e,t);return s&&make_sequence(this,s)})),def_drop_side_effect_free(AST_ObjectProperty,(function(e,t){const s=this instanceof AST_ObjectKeyVal&&this.key instanceof AST_Node&&this.key.drop_side_effect_free(e,t),r=this.value&&this.value.drop_side_effect_free(e,t);return s&&r?make_sequence(this,[s,r]):s||r})),def_drop_side_effect_free(AST_ConciseMethod,(function(){return this.computed_key()?this.key:null})),def_drop_side_effect_free(AST_ObjectGetter,(function(){return this.computed_key()?this.key:null})),def_drop_side_effect_free(AST_ObjectSetter,(function(){return this.computed_key()?this.key:null})),def_drop_side_effect_free(AST_Array,(function(e,t){var s=trim(this.elements,e,t);return s&&make_sequence(this,s)})),def_drop_side_effect_free(AST_Dot,(function(e,t){return is_nullish_shortcircuited(this,e)?this.expression.drop_side_effect_free(e,t):!this.optional&&this.expression.may_throw_on_access(e)?this:this.expression.drop_side_effect_free(e,t)})),def_drop_side_effect_free(AST_Sub,(function(e,t){if(is_nullish_shortcircuited(this,e))return this.expression.drop_side_effect_free(e,t);if(!this.optional&&this.expression.may_throw_on_access(e))return this;var s=this.property.drop_side_effect_free(e);if(s&&this.optional)return this;var r=this.expression.drop_side_effect_free(e,t);return r&&s?make_sequence(this,[r,s]):r||s})),def_drop_side_effect_free(AST_Chain,(function(e,t){return this.expression.drop_side_effect_free(e,t)})),def_drop_side_effect_free(AST_Sequence,(function(e){var t=this.tail_node(),s=t.drop_side_effect_free(e);if(s===t)return this;var r=this.expressions.slice(0,-1);return s&&r.push(s),r.length?make_sequence(this,r):make_node(AST_Number,this,{value:0})})),def_drop_side_effect_free(AST_Expansion,(function(e,t){return this.expression.drop_side_effect_free(e,t)})),def_drop_side_effect_free(AST_TemplateSegment,return_null),def_drop_side_effect_free(AST_TemplateString,(function(e){var t=trim(this.segments,e,first_in_statement);return t&&make_sequence(this,t)}));